<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>ì˜ˆì•½ ì‹œê°„ëŒ€ ê´€ë¦¬</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        input, select, button { display: block; margin-bottom: 12px; padding: 6px; width: 250px; }
        table { margin-top: 20px; border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
        th { background-color: #f2f2f2; }
        #result { margin-top: 15px; color: green; }
    </style>
    <style>
        .timeline {
            display: flex;
            margin-top: 20px;
            border: 1px solid #ccc;
            height: 40px;
            position: relative;
        }
        .slot-block {
            height: 100%;
            text-align: center;
            line-height: 40px;
            color: white;
            font-weight: bold;
            border-right: 1px solid white;
            flex-shrink: 0;
        }
        .gold { background-color: #FFD700; color: black; }
        .silver { background-color: #C0C0C0; color: black; }
        .bronze { background-color: #CD7F32; color: white; }
    </style>
</head>
<body>

<h2>ì‚¬ì¥ë‹˜ ì˜ˆì•½ ê°€ëŠ¥ ì‹œê°„ëŒ€ ë“±ë¡</h2>

<form id="slotForm">
    <label>ê°€ê²Œ ID: <input type="number" id="storeId" required></label>
    <label>ì‹œì‘ ì‹œê°„: <input type="time" id="startTime" required></label>
    <label>ì¢…ë£Œ ì‹œê°„: <input type="time" id="endTime" required></label>
    <label>í—ˆìš© ë“±ê¸‰:
        <select id="allowedMembership" required>
            <option value="GOLD">GOLD</option>
            <option value="SILVER">SILVER</option>
            <option value="BRONZE">BRONZE</option>
        </select>
    </label>
    <button type="submit">ì‹œê°„ëŒ€ ë“±ë¡</button>
</form>

<div id="result"></div>

<h3>ë“±ë¡ëœ ì‹œê°„ëŒ€ ëª©ë¡</h3>
<button onclick="loadSlots()">ì‹œê°„ëŒ€ ìƒˆë¡œê³ ì¹¨</button>
<table id="slotTable">
    <thead>
    <tr>
        <th>ID</th>
        <th>ì‹œì‘ ì‹œê°„</th>
        <th>ì¢…ë£Œ ì‹œê°„</th>
        <th>ë“±ê¸‰</th>
        <th>ì‚­ì œ</th>
    </tr>
    </thead>
    <tbody></tbody>
</table>

<div id="timelineContainer"></div>

<script>
    const form = document.getElementById("slotForm");
    const resultDiv = document.getElementById("result");
    const tableBody = document.querySelector("#slotTable tbody");

    form.addEventListener("submit", async function (e) {
        e.preventDefault();

        const storeId = document.getElementById("storeId").value;
        const startTime = document.getElementById("startTime").value;
        const endTime = document.getElementById("endTime").value;
        const allowedMembership = document.getElementById("allowedMembership").value;

        const requestBody = { storeId, startTime, endTime, allowedMembership };

        try {
            const response = await fetch("/owner/slots", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                credentials: "include",
                body: JSON.stringify(requestBody)
            });

            if (response.ok) {
                const data = await response.json();
                resultDiv.innerText = `âœ… ë“±ë¡ ì™„ë£Œ: ${data.startTime}~${data.endTime} (${data.allowedMembership})`;
                loadSlots(); // ë“±ë¡ í›„ ëª©ë¡ ê°±ì‹ 
            } else {
                resultDiv.innerText = "âŒ ë“±ë¡ ì‹¤íŒ¨: ê¶Œí•œ ì˜¤ë¥˜ ë˜ëŠ” ìš”ì²­ ì˜¤ë¥˜";
            }
        } catch (err) {
            console.error("ì—ëŸ¬ ë°œìƒ:", err);
            resultDiv.innerText = "âš ï¸ ì„œë²„ ì˜¤ë¥˜ ë°œìƒ";
        }
    });

    async function loadSlots() {
        const storeId = document.getElementById("storeId").value;
        if (!storeId) return;

        try {
            const response = await fetch(`/owner/slots?storeId=${storeId}`, {
                method: "GET",
                credentials: "include"
            });

            if (!response.ok) {
                resultDiv.innerText = "âŒ ì‹œê°„ëŒ€ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨";
                return;
            }

            const slots = await response.json();
            tableBody.innerHTML = "";

            slots.forEach(slot => {
                const row = document.createElement("tr");
                row.innerHTML = `
            <td>${slot.slotId}</td>
            <td>${slot.startTime}</td>
            <td>${slot.endTime}</td>
            <td>${slot.allowedMembership}</td>
            <td><button onclick="deleteSlot(${slot.slotId})">ì‚­ì œ</button></td>
          `;
                tableBody.appendChild(row);
            });

        } catch (err) {
            console.error("ì—ëŸ¬ ë°œìƒ:", err);
            resultDiv.innerText = "âš ï¸ ì„œë²„ ì˜¤ë¥˜ ë°œìƒ";
        }
    }

    async function deleteSlot(slotId) {
        if (!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

        try {
            const response = await fetch(`/owner/slots/${slotId}`, {
                method: "DELETE",
                credentials: "include"
            });

            if (response.ok) {
                resultDiv.innerText = `ğŸ—‘ï¸ ìŠ¬ë¡¯ ${slotId} ì‚­ì œ ì™„ë£Œ`;
                loadSlots();
            } else {
                resultDiv.innerText = "âŒ ì‚­ì œ ì‹¤íŒ¨: ê¶Œí•œ ë˜ëŠ” ì„œë²„ ì˜¤ë¥˜";
            }
        } catch (err) {
            console.error("ì‚­ì œ ì—ëŸ¬:", err);
            resultDiv.innerText = "âš ï¸ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ";
        }
    }

    async function loadSlots() {
        const storeId = document.getElementById("storeId").value;
        if (!storeId) return;

        try {
            const response = await fetch(`/owner/slots?storeId=${storeId}`, {
                method: "GET",
                credentials: "include"
            });

            if (!response.ok) {
                resultDiv.innerText = "âŒ ì‹œê°„ëŒ€ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨";
                return;
            }

            const slots = await response.json();
            tableBody.innerHTML = "";
            document.getElementById("timelineContainer").innerHTML = "";

            // í‘œì— í‘œì‹œ
            slots.forEach(slot => {
                const row = document.createElement("tr");
                row.innerHTML = `
          <td>${slot.slotId}</td>
          <td>${slot.startTime}</td>
          <td>${slot.endTime}</td>
          <td>${slot.allowedMembership}</td>
          <td><button onclick="deleteSlot(${slot.slotId})">ì‚­ì œ</button></td>
        `;
                tableBody.appendChild(row);
            });

            // ì‹œê°í™” íƒ€ì„ë¼ì¸ ìƒì„±
            const timeline = document.createElement("div");
            timeline.classList.add("timeline");

            const getHour = timeStr => parseInt(timeStr.split(":")[0]);

            for (let hour = 10; hour < 22; hour++) {
                const slot = slots.find(s => getHour(s.startTime) === hour);
                const block = document.createElement("div");
                block.style.flexBasis = "8.33%"; // 12ì¹¸ (12ì‹œê°„)
                if (slot) {
                    block.classList.add("slot-block");
                    block.classList.add(slot.allowedMembership.toLowerCase());
                    block.innerText = `${slot.startTime}`;
                } else {
                    block.style.backgroundColor = "#eee";
                }
                timeline.appendChild(block);
            }

            document.getElementById("timelineContainer").appendChild(timeline);
        } catch (err) {
            console.error("ì—ëŸ¬ ë°œìƒ:", err);
            resultDiv.innerText = "âš ï¸ ì„œë²„ ì˜¤ë¥˜ ë°œìƒ";
        }
    }
</script>

</body>
</html>
