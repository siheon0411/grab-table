<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>가게 상세보기 | CatchTable</title>
    <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
            rel="stylesheet"
    />
</head>
<body>
<!-- 네비게이션 바 -->
<nav class="navbar navbar-expand-lg navbar-light bg-light shadow-sm">
    <div class="container">
        <a class="navbar-brand" href="#">CatchTable</a>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item"><a class="nav-link" href="/dashboard">대시보드</a></li>
                <li class="nav-item"><a class="nav-link" href="/store-register">가게 등록</a></li>
                <li class="nav-item"><a class="nav-link" href="/logout">로그아웃</a></li>
            </ul>
        </div>
    </div>
</nav>

<div class="container mt-5">
    <!-- 가게명 & 삭제 버튼 -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 id="storeName">가게명 로딩중...</h3>
        <button id="deleteStoreBtn" class="btn btn-danger">가게 삭제하기</button>
    </div>

    <!-- 탭 네비게이션 -->
    <ul class="nav nav-tabs mb-3" id="storeTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button
                    class="nav-link active"
                    id="menu-tab"
                    data-bs-toggle="tab"
                    data-bs-target="#menuTab"
                    type="button"
                    role="tab"
                    aria-controls="menuTab"
                    aria-selected="true"
            >메뉴</button>
        </li>
        <li class="nav-item" role="presentation">
            <button
                    class="nav-link"
                    id="review-tab"
                    data-bs-toggle="tab"
                    data-bs-target="#reviewTab"
                    type="button"
                    role="tab"
                    aria-controls="reviewTab"
                    aria-selected="false"
            >리뷰</button>
        </li>
    </ul>

    <!-- 탭 콘텐츠 -->
    <div class="tab-content" id="storeTabContent">
        <!-- 메뉴 탭 -->
        <div
                class="tab-pane fade show active"
                id="menuTab"
                role="tabpanel"
                aria-labelledby="menu-tab"
        >
            <div class="mb-3 d-flex justify-content-between align-items-center">
                <h5>메뉴 목록</h5>
                <button
                        class="btn btn-primary"
                        data-bs-toggle="modal"
                        data-bs-target="#menuModal"
                        data-action="create"
                >메뉴 추가</button>
            </div>
            <table class="table table-hover">
                <thead>
                <tr>
                    <th>메뉴명</th>
                    <th>가격 (원)</th>
                    <th>이미지</th>
                    <th>작업</th>
                </tr>
                </thead>
                <tbody id="menuTableBody"></tbody>
            </table>
        </div>

        <!-- 리뷰 탭 -->
        <div
                class="tab-pane fade"
                id="reviewTab"
                role="tabpanel"
                aria-labelledby="review-tab"
        >
            <h5 class="mt-3">리뷰 목록</h5>
            <table class="table table-hover">
                <thead>
                <tr>
                    <th>작성자(ID)</th>
                    <th>메뉴명</th>
                    <th>내용</th>
                    <th>이미지</th>
                    <th>작성일</th>
                    <th>수정일</th>
                </tr>
                </thead>
                <tbody id="reviewTableBody"></tbody>
            </table>
            <nav>
                <ul class="pagination justify-content-center" id="reviewPagination"></ul>
            </nav>
        </div>
    </div>
</div>

<!-- 메뉴 추가/수정 Modal -->
<div class="modal fade" id="menuModal" tabindex="-1" aria-labelledby="menuModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <form id="menuForm" enctype="multipart/form-data" class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="menuModalLabel">메뉴 추가</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="menuId" name="menuId" />
                <div class="mb-3">
                    <label for="menuName" class="form-label">메뉴명</label>
                    <input type="text" class="form-control" id="menuName" name="name" required />
                </div>
                <div class="mb-3">
                    <label for="menuPrice" class="form-label">가격</label>
                    <input type="number" class="form-control" id="menuPrice" name="price" required />
                </div>
                <div class="mb-3">
                    <label for="menuImage" class="form-label">이미지</label>
                    <input type="file" class="form-control" id="menuImage" name="imageFile" accept="image/*" />
                </div>
                <div class="mb-3 text-center" id="menuImagePreviewContainer" style="display: none;">
                    <img id="menuImgPreview" class="img-fluid rounded" style="max-height: 150px;" alt="현재 메뉴 이미지" />
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                <button type="submit" class="btn btn-primary">저장</button>
            </div>
        </form>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const params = new URLSearchParams(location.search);
    const storeId = params.get("storeId");
    const reviewPageSize = 5;

    document.addEventListener("DOMContentLoaded", () => {
        loadStore();
        loadMenus();
        loadReviews(0);
        document.getElementById("deleteStoreBtn").addEventListener("click", deleteStore);
        document.getElementById("menuModal").addEventListener("show.bs.modal", onMenuModalShow);
        document.getElementById("menuForm").addEventListener("submit", saveMenu);
    });

    function loadStore() {
        fetch(`/api/admin/stores`)
            .then(res => res.json())
            .then(data => {
                const store = data.storeDtoList.find(s => s.storeId == storeId);
                document.getElementById("storeName").textContent =
                    store ? store.name : "가게 정보 없음";
            });
    }

    function loadMenus() {
        fetch(`/api/admin/stores/${storeId}/menus`)
            .then(res => res.json())
            .then(data => {
                const tbody = document.getElementById("menuTableBody");
                tbody.innerHTML = "";
                (data.menuDtoList || []).forEach(menu => {
                    const tr = document.createElement("tr");
                    tr.innerHTML = `
              <td>${menu.name}</td>
              <td>${menu.price.toLocaleString()}</td>
              <td><img
                    src="data:${menu.imageContentType};base64,${menu.image}"
                    style="width:60px;height:60px;object-fit:cover;"
                  /></td>
              <td>
                <button class="btn btn-sm btn-outline-secondary me-2"
                  data-action="edit" data-id="${menu.menuId}">수정</button>
                <button class="btn btn-sm btn-outline-danger"
                  data-action="delete" data-id="${menu.menuId}">삭제</button>
              </td>`;
                    tbody.appendChild(tr);
                });
                tbody.querySelectorAll("button").forEach(btn => {
                    const id = btn.dataset.id, act = btn.dataset.action;
                    btn.addEventListener("click", () =>
                        act === "edit" ? openEditModal(id) : deleteMenu(id)
                    );
                });
            });
    }

    function loadReviews(pageNumber) {
        // 1) 전체 리뷰 수 조회
        fetch(`/api/admin/stores/${storeId}/reviews/count`)
            .then(res => res.json())
            .then(cntData => {
                const totalCount = cntData.count || 0;
                // 2) 페이징된 리뷰 조회
                return fetch(
                    `/api/admin/stores/${storeId}/reviews`
                    + `?pageNumber=${pageNumber}&pageSize=${reviewPageSize}`
                )
                    .then(res => res.json())
                    .then(pageData => ({ totalCount, reviews: pageData.reviewDtoList || [] }));
            })
            .then(({ totalCount, reviews }) => {
                const tbody = document.getElementById("reviewTableBody");
                tbody.innerHTML = "";
                reviews.forEach(rev => {
                    const tr = document.createElement("tr");
                    tr.innerHTML = `
              <td>${rev.username}</td>
              <td>${rev.menuName}</td>
              <td>${rev.content || ""}</td>
              <td>${rev.image
                        ? `<img src="data:${rev.imageContentType};base64,${rev.image}"
                        style="width:60px;height:60px;object-fit:cover;">`
                        : ""}</td>
              <td>${rev.createdAt
                        ? new Date(rev.createdAt).toLocaleDateString()
                        : ""}</td>
              <td>${rev.updatedAt
                        ? new Date(rev.updatedAt).toLocaleDateString()
                        : ""}</td>`;
                    tbody.appendChild(tr);
                });

                // 페이지네이션 렌더링
                const totalPages = Math.ceil(totalCount / reviewPageSize);
                const ul = document.getElementById("reviewPagination");
                ul.innerHTML = "";

                // Previous
                const prevLi = document.createElement("li");
                prevLi.className = "page-item" + (pageNumber === 0 ? " disabled" : "");
                const prevA = document.createElement("a");
                prevA.className = "page-link"; prevA.href = "#"; prevA.textContent = "Previous";
                prevA.onclick = e => { e.preventDefault(); if (pageNumber > 0) loadReviews(pageNumber - 1); };
                prevLi.appendChild(prevA); ul.appendChild(prevLi);

                // 숫자 페이지
                for (let i = 0; i < totalPages; i++) {
                    const li = document.createElement("li");
                    li.className = "page-item" + (i === pageNumber ? " active" : "");
                    const a = document.createElement("a");
                    a.className = "page-link"; a.href = "#"; a.textContent = i + 1;
                    a.onclick = e => { e.preventDefault(); loadReviews(i); };
                    li.appendChild(a); ul.appendChild(li);
                }

                // Next
                const nextLi = document.createElement("li");
                nextLi.className = "page-item" + (pageNumber >= totalPages - 1 ? " disabled" : "");
                const nextA = document.createElement("a");
                nextA.className = "page-link"; nextA.href = "#"; nextA.textContent = "Next";
                nextA.onclick = e => { e.preventDefault(); if (pageNumber < totalPages - 1) loadReviews(pageNumber + 1); };
                nextLi.appendChild(nextA); ul.appendChild(nextLi);
            })
            .catch(err => console.error("Error loading reviews:", err));
    }

    // 메뉴 모달 초기화
    function onMenuModalShow(e) {
        const trigger = e.relatedTarget;
        if (!trigger) return;
        const form = document.getElementById("menuForm");
        const title = document.getElementById("menuModalLabel");
        document.getElementById("menuImagePreviewContainer").style.display = "none";
        if (trigger.dataset.action === "create") {
            title.textContent = "메뉴 추가";
            form.reset();
            document.getElementById("menuId").value = "";
        }
    }

    // 메뉴 수정 모달 열기
    function openEditModal(id) {
        fetch(`/api/admin/menus/${id}`)
            .then(res => res.json())
            .then(data => {
                const menu = data.menuDto;
                document.getElementById("menuId").value = menu.menuId;
                document.getElementById("menuName").value = menu.name;
                document.getElementById("menuPrice").value = menu.price;
                if (menu.image && menu.imageContentType) {
                    const img = document.getElementById("menuImgPreview");
                    img.src = `data:${menu.imageContentType};base64,${menu.image}`;
                    document.getElementById("menuImagePreviewContainer").style.display = "block";
                }
                document.getElementById("menuModalLabel").textContent = "메뉴 수정";
                new bootstrap.Modal(document.getElementById("menuModal")).show();
            })
            .catch(err => console.error("Error fetching menu:", err));
    }

    // 메뉴 저장
    function saveMenu(e) {
        e.preventDefault();
        const form = e.target;
        const formData = new FormData(form);
        const id = formData.get("menuId");
        if (!formData.get("imageFile")) formData.delete("imageFile");
        const url = id
            ? `/api/admin/menus/${id}`
            : `/api/admin/stores/${storeId}/menus`;
        const method = id ? "PUT" : "POST";
        fetch(url, { method, body: formData })
            .then(() => {
                bootstrap.Modal.getInstance(document.getElementById("menuModal")).hide();
                loadMenus();
            })
            .catch(err => console.error("Error saving menu:", err));
    }

    // 메뉴 삭제
    function deleteMenu(id) {
        if (!confirm("해당 메뉴를 삭제하시겠습니까?")) return;
        fetch(`/api/admin/menus/${id}`, { method: "DELETE" })
            .then(() => loadMenus())
            .catch(err => console.error("Error deleting menu:", err));
    }

    // 가게 삭제
    function deleteStore() {
        if (!confirm("정말 이 가게를 삭제하시겠습니까?")) return;
        fetch(`/api/admin/stores/${storeId}`, { method: "DELETE" })
            .then(() => location.href = "/dashboard.html")
            .catch(err => console.error("Error deleting store:", err));
    }
</script>
</body>
</html>
